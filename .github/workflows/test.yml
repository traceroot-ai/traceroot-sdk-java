name: Test Java

permissions:
  contents: read

'on':
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build Java package
        run: mvn clean install -Dgpg.skip=true

      - name: Run standalone example
        run: |
          cd examples/standalone-example
          timeout 30s mvn clean compile exec:java || exit_code=$?
          if [ $exit_code -eq 124 ]; then
            echo "Standalone example ran successfully (terminated after 30s timeout as expected)"
            exit 0
          elif [ $exit_code -eq 0 ]; then
            echo "Standalone example completed successfully"
            exit 0
          else
            echo "Standalone example failed with exit code: $exit_code"
            exit $exit_code
          fi

      - name: Verify build artifacts
        run: |
          echo "Checking for build artifacts..."
          ls -la target/
          echo "Main JAR file:"
          ls -la target/*.jar | grep -v javadoc | grep -v sources || echo "No main JAR found"
          echo "Build verification completed"

      - name: Test Log4j2 Local Example
        env:
          TRACEROOT_OTLP_ENDPOINT: http://127.0.0.1:4318/v1/traces
        run: |
          cd examples/log4j2-local-example
          echo "Running Log4j2 local example..."
          timeout 30s mvn clean compile exec:java -Dexec.mainClass="com.example.StandaloneExample" || exit_code=$?
          if [ $exit_code -eq 124 ] || [ $exit_code -eq 0 ]; then
            echo "Log4j2 local example ran successfully"
          else
            echo "Log4j2 local example failed with exit code: $exit_code"
            exit $exit_code
          fi

          echo "Validating log file exists..."
          if [ ! -f logs/traceroot-sdk.log ]; then
            echo "Error: Log file not found at logs/traceroot-sdk.log"
            exit 1
          fi

          echo "Validating JSON format..."
          # Check that log file contains valid JSON
          if ! head -1 logs/traceroot-sdk.log | python3 -m json.tool > /dev/null 2>&1; then
            echo "Error: Log file does not contain valid JSON"
            cat logs/traceroot-sdk.log | head -5
            exit 1
          fi

          echo "Validating required TraceRoot fields..."
          # Extract first log entry and validate required fields
          first_log=$(head -1 logs/traceroot-sdk.log)

          required_fields=("github_owner" "trace_id" "environment" "level" "span_id" "github_repo_name" "service_name" "stack_trace" "message" "github_commit_hash" "timestamp")

          for field in "${required_fields[@]}"; do
            if ! echo "$first_log" | grep -q "\"$field\""; then
              echo "Error: Required field '$field' not found in log entry"
              echo "Log entry: $first_log"
              exit 1
            fi
          done

          # Validate that custom fields from user pattern are NOT present (this is local example without custom pattern)
          if echo "$first_log" | grep -q "\"dateTime\"" || echo "$first_log" | grep -q "\"thread\""; then
            echo "Error: Custom user fields should not be present in local example"
            echo "Log entry: $first_log"
            exit 1
          fi

          echo "✓ Log4j2 local example validation passed"

      - name: Test Log4j2 Custom Format Example
        env:
          TRACEROOT_OTLP_ENDPOINT: http://127.0.0.1:4318/v1/traces
        run: |
          cd examples/log4j2-custom-format-example
          echo "Running Log4j2 custom format example..."
          timeout 30s mvn clean compile exec:java -Dexec.mainClass="com.example.StandaloneExample" || exit_code=$?
          if [ $exit_code -eq 124 ] || [ $exit_code -eq 0 ]; then
            echo "Log4j2 custom format example ran successfully"
          else
            echo "Log4j2 custom format example failed with exit code: $exit_code"
            exit $exit_code
          fi

          echo "Validating log file exists..."
          if [ ! -f logs/traceroot-sdk.log ]; then
            echo "Error: Log file not found at logs/traceroot-sdk.log"
            exit 1
          fi

          echo "Validating JSON format..."
          # Check that log file contains valid JSON
          if ! head -1 logs/traceroot-sdk.log | python3 -m json.tool > /dev/null 2>&1; then
            echo "Error: Log file does not contain valid JSON"
            cat logs/traceroot-sdk.log | head -5
            exit 1
          fi

          echo "Validating required TraceRoot fields..."
          # Extract first log entry and validate required fields
          first_log=$(head -1 logs/traceroot-sdk.log)

          required_fields=("github_owner" "trace_id" "environment" "level" "span_id" "github_repo_name" "service_name" "stack_trace" "message" "github_commit_hash" "timestamp")

          for field in "${required_fields[@]}"; do
            if ! echo "$first_log" | grep -q "\"$field\""; then
              echo "Error: Required field '$field' not found in log entry"
              echo "Log entry: $first_log"
              exit 1
            fi
          done

          echo "Validating custom user fields..."
          # Validate that custom fields ARE present (this example has custom pattern)
          custom_fields=("dateTime" "thread" "class" "method")

          for field in "${custom_fields[@]}"; do
            if ! echo "$first_log" | grep -q "\"$field\""; then
              echo "Error: Custom field '$field' not found in log entry"
              echo "Log entry: $first_log"
              exit 1
            fi
          done

          echo "Validating field ordering..."
          # TraceRoot fields should come before custom fields
          # Check that github_owner appears before custom fields like dateTime
          if ! echo "$first_log" | python3 -c 'import json,sys;d=json.load(sys.stdin);keys=list(d.keys());print("PASS" if keys.index("github_owner")<keys.index("dateTime") else "FAIL")' | grep -q "PASS"; then
            echo "Error: TraceRoot fields should appear before custom user fields"
            exit 1
          fi

          echo "✓ Log4j2 custom format example validation passed"
